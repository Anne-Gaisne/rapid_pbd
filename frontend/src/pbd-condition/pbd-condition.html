<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-styles/color.html">
<link rel="import" href="../shared-styles/shared-styles.html">
<link rel="import" href="../pbd-relation-condition/pbd-relation-condition.html">
<link rel="import" href="../pbd-arm-cart-action/pbd-arm-cart-action.html">
<link rel="import" href="../pbd-detect-surface-objects-action/pbd-detect-surface-objects-action.html">
<link rel="import" href="../pbd-gripper-action/pbd-gripper-action.html">
<link rel="import" href="../pbd-head-action/pbd-head-action.html">
<link rel="import" href="../pbd-joint-angle-action/pbd-joint-angle-action.html">

<dom-module id="pbd-condition">
  <template>
    <style include="shared-styles"></style>
    <style is="custom-style" include="iron-flex iron-flex-alignment"></style>
    <style>
      :host {
        display: block;
      }
      .paper-material {
        background-color: #fff;
        padding: 10px;
        margin-top: 10px;
      }
      h4 {
        margin: 0px 0px;
      }
      paper-icon-button {
        color: var(--paper-grey-500);
      }
    </style>
    <div class="paper-material">
      <div class="layout horizontal center">
        <h4>[[_actionDescription]]</h4>
        <div class="flex"></div>
        <paper-icon-button icon="delete" on-tap="_delete"></paper-icon-button>
        <paper-icon-button icon="expand-less" hidden$="[[!_isCollapseOpen]]" on-tap="toggleCollapse"></paper-icon-button>
        <paper-icon-button icon="expand-more" hidden$="[[_isCollapseOpen]]" on-tap="toggleCollapse"></paper-icon-button>
      </div>
      <iron-collapse id="collapse" opened="[[_isCollapseOpen]]">
        <paper-dropdown-menu label="Action type">
          <paper-listbox slot="dropdown-content" attr-for-selected="data-type" selected="{{_displayActionType}}">
            <paper-item data-type="open gripper">Open gripper</paper-item>
            <paper-item data-type="close gripper">Close gripper</paper-item>
            <paper-item data-type="spatial relation">Relation</paper-item>
            <paper-item data-type="move to joint goal">Move to joint angles</paper-item>
            <paper-item data-type="move head">Move head</paper-item>
            <paper-item data-type="detect tabletop objects">Detect tabletop objects</paper-item>
            <!--paper-item data-type="find custom landmark">Find custom landmark</paper-item-->
          </paper-listbox>
        </paper-dropdown-menu>
        <template is="dom-if" restamp if="[[_displayActionTypeIs(_displayActionType, 'open gripper')]]">
          <pbd-gripper-action id="gripperAction" action="{{action}}" params="[[params]]" ros="[[ros]]"></pbd-gripper-action>
        </template>
        <template is="dom-if" restamp if="[[_displayActionTypeIs(_displayActionType, 'close gripper')]]">
          <pbd-gripper-action id="gripperAction" action="{{action}}" params="[[params]]" ros="[[ros]]"></pbd-gripper-action>
        </template>
        <template is="dom-if" restamp if="[[_displayActionTypeIs(_displayActionType, 'spatial relation')]]">
          <pbd-relation-condition action="{{condition}}" params="[[params]]" 
            program-id="[[programId]]" step-index="[[stepNum]]" index="[[index]]"
            landmarks="[[landmarks]]" ros="[[ros]]"></pbd-relation-condition>
        </template>
        <template is="dom-if" restamp if="[[_displayActionTypeIs(_displayActionType, 'move to joint goal')]]">
          <pbd-joint-angle-action action="{{action}}" program-id="[[programId]]" step-index="[[stepNum]]" index="[[index]]" params="[[params]]" ros="[[ros]]"></pbd-joint-angle-action>
        </template>
        <template is="dom-if" restamp if="[[_displayActionTypeIs(_displayActionType, 'move head')]]">
          <pbd-head-action action="{{action}}" params="[[params]]" ros="[[ros]]"></pbd-head-action>
        </template>
        <template is="dom-if" restamp if="[[_displayActionTypeIs(_displayActionType, 'detect tabletop objects')]]">
          <pbd-detect-surface-objects-action action="{{action}}" program-id="[[programId]]" step-num="[[stepNum]]" ros="[[ros]]"></pbd-detect-surface-objects-action>
        </template>
        <template is="dom-if" restamp if="[[_displayActionTypeIs(_displayActionType, 'find custom landmark')]]">
          CustomLandmarks options
        </template>
      </iron-collapse>
    </div>
  </template>
  <script>
    Polymer({
      is: 'pbd-condition',

      properties: {
        condition: {
          notify: true,
          type: Object,
        },
        params: Object,
        landmarks: Array,
        //type: String,
        landmark: Object,
        reference: Object,
        stepNum: Number,
        index: Number,
        programId: String,
        ros: Object,
        _isCollapseOpen: {
          type: Boolean,
          value: true,
        },
      },

      observers: [
        '_computeActionDescription(condition.*, index)',
        '_actionTypeChanged(condition.type)',
        '_displayActionTypeChanged(_displayActionType)',
      ],

      toggleCollapse: function() {
        this._isCollapseOpen = !this._isCollapseOpen;
      },

      _computeActionDescription(changeRecord, index) {
          console.debug('Landmarks: ', this.landmarks.length );
        this._actionDescription = 'Condition ' + (index+1);
        this.landmark = this.condition.landmark;
        this.type = this.condition.type;
          console.debug('Condition ', index+1, this.landmark.name, this.type );
        if (this.condition.type === 'landmark is visible') {
          console.debug('Visibility: ', index+1 );
          // this._actionDescription = 'Move arm';
          // if (this.condition.actuator_group === 'arm'
          //     || this.condition.actuator_group === 'left arm'
          //     || this.condition.actuator_group === 'right arm') {
          //   this._actionDescription = 'Move ' + this.condition.actuator_group;
          // }
        } else if (this.condition.type === 'property of the landmark') {
          console.debug('Property :', this.condition.property, this.condition.threshold);
          if (this.condition.property === 'landmark position') {

          }
          this._actionDescription = this.landmark.name + ' properties';
          if (this.condition.actuator_group === 'arm'
              || this.condition.actuator_group === 'left arm'
              || this.condition.actuator_group === 'right arm') {
            this._actionDescription = 'Move ' + this.condition.actuator_group;
          } else if (this.condition.actuator_group === 'head') {
            this._actionDescription = 'Move head';
          }
        } else if (this.condition.type === 'spatial relation with a reference landmark') {
          this.reference = this.condition.reference;
          var displacement = this.condition.displacement;
          var spatial_relation = this.condition.spatial_relation;
          console.debug('Relation : ', this.landmark.name,  spatial_relation, this.reference.name );
          this._actionDescription = this.landmark.name + ' relative to ' + this.reference.name;
          if (this.condition.actuator_group === 'arm'
              || this.condition.actuator_group === 'left arm'
              || this.condition.actuator_group === 'right arm') {
            this._actionDescription = 'Move ' + this.condition.actuator_group;
          } else if (this.condition.actuator_group === 'head') {
            this._actionDescription = 'Move head';
          }
        } 
      },

      _delete: function() {
        this.fire('delete', {index: this.index});
      },

      _actionTypeChanged: function(actionType) {
        if (actionType === 'actuate gripper') {
          if (this.condition.gripper_command.position > 0) {
            this._displayActionType = 'open gripper';
          } else {
            this._displayActionType = 'close gripper';
          }
        } else if (actionType === 'move to joint goal') {
          if (this.condition.actuator_group === 'head') {
            this._displayActionType = 'move head';
          } else {
            this._displayActionType = 'move to joint goal';
          }
        } else {
          if (this._displayActionType !== actionType) {
            this._displayActionType = actionType;
          }
        }
      },

      _displayActionTypeChanged: function(displayActionType) {
        if (displayActionType === 'open gripper') {
          this.set('condition.type', 'actuate gripper');
          this.set('condition.gripper_command.position', 0.1);
          this.set('condition.gripper_command.max_effort', 0);
        } else if (displayActionType === 'close gripper') {
          this.set('condition.type', 'actuate gripper');
          this.set('condition.gripper_command.position', 0);
          if (!this.condition.gripper_command.max_effort) {
            this.set('condition.gripper_command.max_effort', 75);
          }
        } else if (displayActionType === 'move head') {
          this.set('condition.type', 'move to joint goal');
          this.set('condition.actuator_group', 'head');
        } else {
          if (this.condition.type !== displayActionType) {
            this.set('condition.type', displayActionType);
          }
        }
      },

      _displayActionTypeIs: function(current, displayActionType) {
        return current === displayActionType;
      },
    });
  </script>
</dom-module>

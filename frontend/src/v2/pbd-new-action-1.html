<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">

<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/ros-topic/ros-topic.html">
<link rel="import" href="../../bower_components/ros-rviz/ros-rviz.html">
<link rel="import" href="../shared-styles.html">
<link rel="import" href="pbd-object-select.html">
<link rel="import" href="pbd-world-state-select.html">

<dom-module id="pbd-new-action-1">
    <template>
        <style include="shared-styles"></style>
        <style is="custom-style" include="iron-flex iron-flex-alignment"></style>
        <style>
            #rviz {
                display: block;
                height: 500px;
            }

            @media (min-width: 768px) {
                #layout {
                    height: 100%;
                }
                .content {
                    @apply(--layout-horizontal);
                    @apply(--layout-flex);
                }
                #rviz {
                    height: 100%;
                    width: 350px;
                    @apply(--layout-flex);
                }
            }

            #form {
                border: 0px solid;
                box-sizing: border-box;
                padding: 2%;
                padding-top: 0;
            }

            #form div {
                display: inline-block;
            }

            #left {
                width: 40%;
            }

            #right {
                width: 59%;
            }

            fieldset iron-icon {
                display: inline-block;
                vertical-align: top;
                margin-top: 5px;
            }

            .petit {
                font-size: 80%;
                margin-left: 20%;
                color: steelblue;
            }

            #detect {
                margin-top: 20px;
                float: right;
            }

            fieldset>p {
                display: inline-block;
            }

            #label2 {
                margin-left: 105px;
            }

            #next {
                float: right;
                margin: 10px;
            }

            paper-input {
                width: 40%;
                display: inline-block;
            }
        </style>
        <app-route route="{{route}}" pattern="/:id" data="{{routeData}}"></app-route>

        <ros-topic auto id="eventPub" msg-type="rapid_pbd_msgs/EditorEvent" topic="rapid_pbd/editor_events" ros="[[ros]]"></ros-topic>
        <ros-topic auto last-message="{{isRunning}}" msg-type="std_msgs/Bool" topic="rapid_pbd/is_running" ros="[[ros]]"></ros-topic>

        <!-- <body class="fullbleed layout vertical"> -->
        <div id="form">
            <div id="left">
                <paper-input label="Enter action name"></paper-input>

                <paper-button id="detect" class="normal" raised on-tap="_detect">Detect world state</paper-button>

                <p>The world types have been detected as shown on the right :</p>

                <fieldset>
                    <legend>Objects detected</legend>
                    <p>Instance name</p>
                    <p id="label2">Instance type</p>
                    <br>

                    <div id="listeObjet">
                        <pbd-object-select id="selectObj1" on-delete="deleteObj" num="1"></pbd-object-select>
                    </div>

                    <br>
                    <paper-button noink class="petit" on-click="newObj">+ add new instance</paper-button>
                </fieldset>

                <fieldset>
                    <legend>Initial world state</legend>
                    <div id="listeWorldState">
                        <pbd-world-state-select id="selectPred-1" on-delete="deletePred" num="1"></pbd-world-state-select>
                    </div>
                    <paper-button noink class="petit" on-click="newPrecond">+ add new predicate</paper-button>
                </fieldset>
            </div>
            <div id="right">
<!--                 <ros-rviz id="rviz" ros="[[ros]]"></ros-rviz>
 -->            </div>
        </div>
        <paper-button id="next" raised class="important">Start teaching module</paper-button>
        
    </template>
    <script>
        Polymer({
            is: 'pbd-new-action-1',

            properties: {
                ros: Object,
                route: Object,
                isRunning: {
                    type: Object,
                    value: function () {
                        return { data: false };
                    }
                },
                pddlDomain: {
                    type: Object,
                    value: function () {
                        return { actions: [] };
                    }
                },
                types: Array,
                predicates: Array,
                actions: Array,

                actionName: {
                    type: String,
                    value: ''
                },
                nbObj: {
                    type: Number,
                    value: 1
                },
                nbPrecond: {
                    type: Number,
                    value: 1
                },
                // a remplacer si possible mais comment ?
                // tableau d'entier [1,2,3] allant jusqu'a nbPrecond, utilis√© pour dom-repeat qui veut un array et non un number
                listObj: {
                    type: Array,
                    value: [1]
                },
                listPrecond: {
                    type: Array,
                    value: [1]
                },
            },

            observers: [
                'load(routeData.id, params.*)',
                '_isRunningChanged(isRunning.data)',
            ],
            newPrecond: function () {
                this.nbPrecond++;
                this.push('listPrecond', this.nbPrecond);
                // On rajoute dynamiquement l'objet
                var dynamicSelect = document.createElement("pbd-world-state-select");
                dynamicSelect.num = this.nbPrecond;
                var newId = "selectPrecond" + this.nbPrecond;
                dynamicSelect.id = newId;
                dynamicSelect.addEventListener('delete', this.deletePred);
                Polymer.dom(this.root).querySelector("#listeWorldState").appendChild(dynamicSelect);
            },
            newObj: function () {
                this.nbObj++;
                this.push('listObj', this.nbObj);
                // On rajoute dynamiquement l'objet
                var dynamicSelect = document.createElement("pbd-object-select");
                dynamicSelect.num = this.nbObj;
                var newId = "selectObj" + this.nbObj;
                dynamicSelect.id = newId;
                dynamicSelect.addEventListener('delete', this.deleteObj);
                Polymer.dom(this.root).querySelector("#listeObjet").appendChild(dynamicSelect);
            },
            deleteObj: function (e) {
                var name = "selectObj" + e.detail.id;
                this.$.name.hello();
            },
            deletePred: function (e) {
                // TODO
            },

            _detect: function () {
                if (!this.ros) {
                    console.error('Unable to call detection right now.');
                    return;
                }
                var msg = {
                    type: 'detect surface objects',
                    program_info: {
                        db_id: this.programId
                    },
                    step_num: 0//this.stepNum
                };
                this.$.eventPub.publish(msg);
            },
            _isRunningChanged: function (isRunning) {
                if (isRunning) {
                    this.$.rviz.set('config.displays.1.isShown', false);
                    this.$.rviz.set('config.displays.2.isShown', false);
                    this.$.rviz.set('config.displays.3.isShown', false);
                    this.$.rviz.set('config.displays.4.isShown', true);
                    this.$.rviz.set('config.displays.5.isShown', true);
                    this.$.rviz.set('config.displays.6.isShown', true);
                } else {
                    this.$.rviz.set('config.displays.1.isShown', true);
                    this.$.rviz.set('config.displays.2.isShown', true);
                    this.$.rviz.set('config.displays.3.isShown', true);
                    this.$.rviz.set('config.displays.4.isShown', false);
                    this.$.rviz.set('config.displays.5.isShown', false);
                    this.$.rviz.set('config.displays.6.isShown', false);
                }
            },

        });
    </script>
</dom-module>
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html"
<link rel="import" href="../../bower_components/paper-input/paper-input.html">

<link rel="import" href="../../bower_components/paper-styles/color.html">
<link rel="import" href="../../bower_components/ros-action-client/ros-action-client.html">

<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/ros-service/ros-service.html">
<link rel="import" href="../../bower_components/ros-topic/ros-topic.html">
<link rel="import" href="../../bower_components/ros-rviz/ros-rviz.html">
<link rel="import" href="../shared-styles.html">
<link rel="import" href="../underscore.html">

<dom-module id="pbd-new-action">
    <template>
        <style include="shared-styles"></style>
        <style is="custom-style" include="iron-flex iron-flex-alignment"></style>
        <style>
            :host {
                display: block;
                height: 100%;
            }

            .paper-material {
                margin-top: 7px;
            }

            a {
                color: #000;
                text-decoration: none;
            }

            .add {
                height: 25px;
                padding: 5px 5px;
                line-height: 14px;
                margin-bottom: 5px;
            }


            paper-button {
                /* float: right; */
                margin: 5px;
            }

            paper-input {
                width: 40%;
                display: inline-block;
            }

            paper-dropdown-menu {
                max-width: 100px;
                margin-left: 10px;
                margin-top: 0px;
            }

            .stepDiv {
                min-width: 350px;
                margin-bottom: 10px;
                overflow-y: auto;
                padding-left: 2px;
                padding-right: 2px;
                padding-bottom: 2px;
                display: inline-block;
            }

            #rviz {
                display: block;
                height: 500px;
            }

            fieldset>p {
                display: inline-block;
            }

            fieldset iron-icon {
                display: inline-block;
                vertical-align: top;
                margin-top: 5px;
            }

            .delete {
                font-size: 80%;
                padding: 0;
                width: 5px;
                color: black;
            }

            .petit {
                font-size: 80%;
                /* margin-left: 20%; */
                color: steelblue;
            }

            @media (min-width: 768px) {
                #layout {
                    height: 100%;
                }
                .content {
                    @apply(--layout-horizontal);
                    @apply(--layout-flex);
                }
                .stepDiv {
                    width: 350px;
                    max-height: 100%;
                    margin-bottom: 0px;
                    margin-right: 10px;
                    padding: 2%;
                }
                #rviz {
                    height: 100%;
                    width: 350px;
                    @apply(--layout-flex);
                }
                .button_not {
                    vertical-align: bottom;
                    padding-bottom: 9px;
                    padding-left: 6px;
                }
            }
        </style>
        <app-route route="{{route}}" pattern="/:id" data="{{routeData}}"></app-route>
        <ros-topic id="programSub" on-message="_handleProgram" msg-type="rapid_pbd_msgs/Program" topic="rapid_pbd/program/{{routeData.id}}"
            ros="[[ros]]"></ros-topic>
        <ros-topic auto id="eventPub" msg-type="rapid_pbd_msgs/EditorEvent" topic="rapid_pbd/editor_events" ros="[[ros]]"></ros-topic>
        <ros-action-client id="programAction" ros="[[ros]]" server="/rapid_pbd/execute_program_action" action-type="rapid_pbd_msgs/ExecuteProgramAction"
            on-feedback="_handleFeedback" on-result="_handleResult"></ros-action-client>
        <ros-topic auto last-message="{{isRunning}}" msg-type="std_msgs/Bool" topic="rapid_pbd/is_running" ros="[[ros]]"></ros-topic>
        <ros-service auto id="createSrv" on-fail="_handleServiceError" on-response="_handleServiceResponse" name="/rapid_pbd/create_program"
            ros="[[ros]]" service-type="rapid_pbd_msgs/CreateProgram"></ros-service>
        <!-- PDDL -->
        <ros-topic auto last-message="{{pddlDomain}}" msg-type="rapid_pbd_msgs/PDDLDomain" topic="rapid_pbd/pddl_domain" ros="[[ros]]"></ros-topic>
        <ros-topic auto last-message="{{domainList}}" msg-type="rapid_pbd_msgs/PDDLDomainInfoList" topic="rapid_pbd/domain_list"
            ros="[[ros]]"></ros-topic>

        <div id="layout" class="layout vertical">
            <div class="content">
                <div id="stepContent">
                    <div>
                        <paper-button class="back clear" on-tap="_goBeforeDemo" hidden$=[[!_finishedDemo]]>
                            <iron-icon icon="arrow-back"></iron-icon> Back</paper-button>
                        <paper-button class="back clear" on-tap="_goBeforeDemo" hidden$=[[_finishedDemo]]>
                            Next
                            <iron-icon icon="arrow-forward"></iron-icon>
                        </paper-button>
                        <paper-input id="actionName" label="Action name" value="{{actionName}}"></paper-input>
                        <a href="#/program/{{action.program_id}}">
                            <paper-button id="next" raised class="important" on-click="_startDemo">
                                Demo Mode >
                            </paper-button>
                        </a>
                    </div>

                    <!-- ***** BEFORE DEMO **** 1/2 -->
                    <div id="beforeDemo" hidden$=[[_finishedDemo]]>
                        <fieldset>
                            <legend>
                                <paper-button id="detect" raised class="clear" on-tap="_detect" data-args="Precondition">
                                    Detect World Instances
                                </paper-button>
                            </legend>
                            <p>Verify all objects have been detected before proceeding.
                                <br>
                                <b>Name</b> (type)</p>
                            <br>
                            <template is="dom-repeat" items="{{sortByName(action.params)}}" as="item" index-as="paramIndex">
                                <div id="listeObjet">
                                    <paper-icon-button icon="check"></paper-icon-button>
                                    [[item.name]] ([[item.type.name]])
                                </div>
                            </template>
                            <br>
                        </fieldset>
                    </div>                    
                    <!-- ***** AFTER DEMO **** 2/2 -->
                    <div id="afterDemo" hidden$=[[!_finishedDemo]]>
                        <fieldset>
                            <paper-button id="detect2" raised class="petit" on-tap="_detect" data-args="Effect">
                                Detect Effects
                            </paper-button>
                            <paper-button class="petit" raised on-tap="_generateConditions">
                                Generate Conditions
                            </paper-button>

                            <paper-button id="next" raised class="important" on-click="save">
                                Save
                            </paper-button>
                        </fieldset>
                        <fieldset>
                            <legend>
                                Preconditions
                            </legend>
                            <template is="dom-repeat" items="{{action.preconditions}}" as="item" index-as="paramIndex">
                                <div id="listeWorldState">
                                    [[item.arg1.name]] is [[_negate(item.negate)]] [[item.name]] [[item.arg2.name]]
                                    <paper-button class="delete" on-tap="deletePred" data-args="Precondition">
                                        <paper-icon-button icon="delete"></paper-icon-button>
                                    </paper-button>
                                </div>
                            </template>

                            <div>
                                <paper-dropdown-menu id="menu_instance1_precond" label="Instance 1">
                                    <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{newPrecondition.arg1}}">
                                        <template is="dom-repeat" items="[[action.params]]">
                                            <paper-item name="[[item]]" on-tap="_updatePredicate" data-args="newPrecondition.arg1">
                                                [[item.name]]
                                            </paper-item>
                                        </template>
                                    </paper-listbox>
                                </paper-dropdown-menu>
                                <paper-radio-button class="button_not" id="button_not_precond">not</paper-radio-button>
                                <paper-dropdown-menu id="menu_name_precond" label="Predicate">
                                    <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{newPrecondition.name}}">
                                        <template is="dom-repeat" items="[[domain.predicates]]">
                                            <paper-item name="[[item.name]]" on-tap="_updatePredicate" data-args="newPrecondition.predicate.name">is [[item.name]]</paper-item>
                                        </template>
                                    </paper-listbox>
                                </paper-dropdown-menu>
                                <paper-dropdown-menu id="menu_instance2_precond" label="Instance 2">
                                    <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{newPrecondition.arg2}}">
                                        <template is="dom-repeat" items="[[action.params]]">
                                            <paper-item name="[[item]]" on-tap="_updatePredicate" data-args="newPrecondition.arg2">
                                                [[item.name]]</paper-item>
                                        </template>
                                    </paper-listbox>
                                </paper-dropdown-menu>
                            </div>
                            <br>
                            <paper-button noink class="petit" on-click="addPredicate" data-args="Precondition">+ add new predicate</paper-button>
                        </fieldset>

                        <fieldset>
                            <legend>
                                Effects
                            </legend>

                            <template is="dom-repeat" items="{{action.effects}}" as="item" index-as="paramIndex">
                                <div id="listeWorldState2">
                                    [[item.arg1.name]] is [[_negate(item.negate)]] [[item.name]] [[item.arg2.name]]
                                    <paper-button class="delete" on-tap="deletePred" data-args="Precondition">
                                        <paper-icon-button icon="delete"></paper-icon-button>
                                    </paper-button>
                                </div>
                            </template>

                            <div>
                                <paper-dropdown-menu id="menu_instance1_effect" label="Instance 1">
                                    <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{newEffect.arg1}}">
                                        <template is="dom-repeat" items="[[action.params]]">
                                            <paper-item name="[[item]]" on-tap="_updatePredicate" data-args="newEffect.arg1">
                                                [[item.name]]</paper-item>
                                        </template>
                                    </paper-listbox>
                                </paper-dropdown-menu>
                                <paper-radio-button class="button_not" id="button_not_effect">not</paper-radio-button>                            
                                <paper-dropdown-menu id="menu_name_effect" label="Predicate">
                                    <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{newEffect.name}}">
                                        <template is="dom-repeat" items="[[domain.predicates]]">
                                            <paper-item name="[[item.name]]" on-tap="_updatePredicate" data-args="newEffect.predicate.name">is [[item.name]]</paper-item>
                                        </template>
                                    </paper-listbox>
                                </paper-dropdown-menu>
                                <paper-dropdown-menu id="menu_instance2_effect" label="Instance 2">
                                    <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{newEffect.arg2}}">
                                        <template is="dom-repeat" items="[[action.params]]">
                                            <paper-item name="[[item]]" on-tap="_updatePredicate" data-args="newEffect.arg2">
                                                [[item.name]]</paper-item>
                                        </template>
                                    </paper-listbox>
                                </paper-dropdown-menu>
                            </div>
                            <br>
                            <paper-button noink class="petit" on-click="addPredicate" data-args="Effect">+ add new predicate</paper-button>
                        </fieldset>
                    </div>
                </div>
                <!--<ros-rviz id="rviz" ros="[[ros]]"></ros-rviz>-->
            </div>
        </div>
        <paper-dialog id="errorDialog" modal>
            <h2>Error running the program</h2>
            <p>[[error]]</p>
            <div class="buttons">
                <paper-button dialog-confirm class="clear">OK</paper-button>
            </div>
        </paper-dialog>
        <paper-dialog id="errorNewPrecond">
            <h2>Error creating new precondition</h2>
            <p id="msgErrorNewPrecond">An error has been encountered ...</p>
            <div class="buttons">
                <paper-button dialog-confirm class="clear">OK</paper-button>
            </div>
        </paper-dialog>
        <paper-dialog id="errorNewEffect">
            <h2>Error creating new effect</h2>
            <p id="msgErrorNewEffect">An error has been encountered ...</p>
            <div class="buttons">
                <paper-button dialog-confirm class="clear">OK</paper-button>
            </div>
        </paper-dialog>
    </template>

    <script>
        Polymer({
            is: 'pbd-new-action',
            properties: {
                _finishedDemo: {
                    type: Object,
                    value: false
                },
                action: Object,
                domain: Object,
                domainID: String,
                params: Object,
                program: {
                    type: Object,
                    observer: '_programChanged',
                },
                ros: Object,
                route: Object,
                isRunning: {
                    type: Object,
                    value: function () {
                        return { data: false };
                    }
                },
                domainList: {
                    type: Object,
                    value: function () {
                        return { domains: [] };
                    }
                },
                pddlDomain: {
                    type: Object,
                    value: function () {
                        return { actions: [] };
                    }
                },
                newPrecondition: {
                    type: Object,
                    value: function () {
                        return {
                            arg1: Object,
                            name: '',
                            arg2: Object,
                            negate: false,
                        };
                    }
                },
                newEffect: {
                    type: Object,
                    value: function () {
                        return {
                            arg1: Object,
                            name: '',
                            arg2: Object,
                            negate: false,
                        };
                    }
                },
                actionName: String,
            },

            observers: [
                'load(routeData.id, params.*)',
                '_programUpdated(program.*)',
                '_domainUpdated(pddlDomain.*,domainList.*)',
                '_actionUpdated(action.*)',
                '_isRunningChanged(isRunning.data)',
                '_checkClearPrecond(newPrecondition.name)',
                '_checkClearEffect(newEffect.name)',
            ],
            _checkClearPrecond: function(nom_precond) {
                if (nom_precond == "clear") {
                    this.$.menu_instance2_precond.disabled = true;
                    this.$.menu_instance2_precond.value = undefined;
                    this.newPrecondition.arg2 = undefined;
                } else {
                    this.$.menu_instance2_precond.disabled = false;
                }
            },
            _checkClearEffect: function(nom_effect) {
                if (nom_effect == "clear") {
                    this.$.menu_instance2_effect.disabled = true;
                    this.$.menu_instance2_effect.value = undefined;
                    this.newEffect.arg2 = undefined;
                } else {
                    this.$.menu_instance2_effect.disabled = false;
                }
            },
            _actionUpdated: function (action) {
                if (action.value && action.value.name != '') {
                    //console.debug('_actionUpdated: action =  ', action.value);
                    this.actionName = action.value.name;
                }
            },
            getAction: function (actionName) {
                if (this.pddlDomain) {
                    for (var i = 0; i < this.pddlDomain.actions.length; ++i) {
                        var action = this.pddlDomain.actions[i];
                        if (action.name === actionName) {
                            this.action = action;
                            //console.debug('Action found ', this.action);
                            return;
                        }
                    }
                }
                console.info('No action found with name ', actionName);
                return;
            },
            load: function (db_id, paramsChangeRecord) {
                /* if (!db_id) {
                    return;
                } */

                if (!this.params.robot) {
                    return;
                }
                this.$.programSub.subscribe();
                var depthCloudFrameId = '';
                if (this.params.robot === "pr2") {
                    depthCloudFrameId = '/head_mount_kinect_rgb_optical_frame';
                } else if (this.params.robot === "fetch") {
                    depthCloudFrameId = '/head_camera_rgb_optical_frame';
                } else if (this.params.robot === "baxter") {
                    depthCloudFrameId = '/kinect2_rgb_optical_frame';
                } else {
                    console.error('Unknown robot type', this.params.robot);
                }

                var fixedFrame = '';
                if (this.params.robot === "pr2" || this.params.robot === "fetch") {
                    fixedFrame = '/base_link';
                } else if (this.params.robot === "baxter") {
                    fixedFrame = '/base';
                } else {
                    console.error('Unknown robot type', this.params.robot);
                }
                if (this.action) {
                    db_id = this.action.program_id;
                }
                var config = {
                    globalOptions: {
                        background: '#113344',
                        colladaLoader: 'collada2',
                        colladaServer: window.location.protocol + '//' + window.location.hostname + ':8001/',
                        fixedFrame: fixedFrame,
                        videoServer: window.location.protocol + '//' + window.location.hostname + ':9998',
                        url: 'ws://' + window.location.hostname + ':9090'
                    },
                    displays: [
                        {
                            isShown: true,
                            name: 'Grid',
                            type: 'grid',
                            options: {
                                cellSize: 1,
                                color: '#cccccc',
                                numCells: 20,
                            },
                        }, {
                            isShown: false,
                            name: 'Program robot model',
                            type: 'markerArray',
                            options: {
                                topic: '/rapid_pbd/robot/' + db_id,
                            },
                        }, {
                            isShown: true,
                            name: 'Scene',
                            type: 'pointCloud2',
                            options: {
                                size: 0.01,
                                topic: '/rapid_pbd/scene/' + db_id,
                            },
                        }, {
                            isShown: true,
                            name: 'Surface segmentation',
                            type: 'markers',
                            options: {
                                topic: '/rapid_pbd/surface_seg/visualization/'// + db_id,
                            },
                        }, {
                            isShown: true,
                            name: 'Current robot model',
                            type: 'urdf',
                            options: {
                                param: 'robot_description',
                                tfPrefix: ''
                            },
                        }, {
                            isShown: false,
                            name: 'Current surface segmentation',
                            type: 'markerArray',
                            options: {
                                topic: '/rapid_pbd/runtime_segmentation',
                            },
                        }, {
                            isShown: false,
                            name: 'Current depth cloud',
                            type: 'depthCloud',
                            options: {
                                topic: 'depthcloud_encoded',
                                frameId: depthCloudFrameId
                            },
                        },
                    ],
                    sidebarOpened: false,
                };
                if (this.$.rviz) {
                    this.$.rviz.config = config;
                } else {
                    console.info('rviz not ready');
                }

            },

            _updatePredicate: function (evt) {
                var args = evt.target.getAttribute('data-args');
                this.set(args, evt.target.name);
                console.debug(args, ' is ', this.newPrecondition);
            },
            checkPredicate: function(mode, _new) {       
                var newItem = _new;
                var valide = true;
                var index = 0;
                // msgErreur explains why the precond isn't valid
                var msgErreur = "";  

                if (mode == "precondition") {
                    var liste = this.action.preconditions;
                    // Check if items are well selected
                    if (this.$.menu_instance1_precond.value == undefined || this.$.menu_name_precond.value == undefined || (this.$.menu_name_precond.value != "is clear" && this.$.menu_instance2_precond.value == undefined)) {
                        valide = false;
                        msgErreur = "Complete your new predicate before adding it";
                    }
                } else {
                    var liste = this.action.effects;
                    // Check if items are well selected
                    if (this.$.menu_instance1_effect.value == undefined || this.$.menu_name_effect.value == undefined || (this.$.menu_name_effect.value != "is clear" && this.$.menu_instance2_effect.value == undefined)) {
                        valide = false;
                        msgErreur = "Complete your new predicate before adding it";
                    }
                }  
                
                if (valide) {
                    // Without negation
                    if (!newItem.negate) {
                        // To comment when you want to test else it's impossible to test on simulation              
                        //else if (newItem.arg1.type.name == "position" && newItem.name == "on") {
                        //    valide = false;
                        //    msgErreur = "A position can't be on something else"
                        //}
                                
                        while (valide && index < liste.length) {
                            if (newItem.name == "clear" && liste[index].name == "clear" && newItem.arg1.name == liste[index].arg1.name) {
                                valide = false;
                                msgErreur = "This " + mode + " exists already";
                            }               
                            else if (newItem.name == liste[index].name && newItem.arg1.name == liste[index].arg1.name && newItem.arg2.name == liste[index].arg2.name) {
                                valide = false;
                                msgErreur = "This " + mode + " exists already";
                            }
                            else if (newItem.name == "on" && liste[index].name == "on") {
                                if (newItem.arg2.name == liste[index].arg2.name) {
                                    valide = false;
                                    msgErreur = "You can't place two objects on one position, see :<br><strong>" + liste[index].arg1.name + liste[index].name + liste[index].arg2.name + "</strong>";
                                } else if (newItem.arg1.name == liste[index].arg1.name) {
                                    valide = false;
                                    msgErreur = "One object can't be on two positions, see :<br><strong>" + liste[index].arg1.name + liste[index].name + liste[index].arg2.name + "</strong>";
                                }
                            }
                            else if (newItem.name == "clear" && (liste[index].name == "on" && liste[index].arg2.name == newItem.arg1.name)) {
                                valide = false;
                                msgErreur = "It is not possible to be clear and to have something on it at the same time, see :<br><strong>" + liste[index].arg1.name + "is " + liste[index].name + " " + liste[index].arg2.name + "</strong>";
                            }
                            else if (liste[index].name == "clear" && (newItem.name == "on" && newItem.arg2.name == liste[index].arg1.name)) {
                                valide = false;
                                msgErreur = "It is not possible to be clear and to have something on it at the same time, see :<br><strong>" + liste[index].arg1.name + " is " + liste[index].name + "</strong>";
                            }
                            index++;
                        }
                    // With negation
                    } else {

                    }
                }
                return {valid: valide, msg: msgErreur};
            },
            addPredicate: function (evt) {
                var condition = evt.target.getAttribute('data-args');
                if (condition == "Precondition") {
                    // Check if the NOT-button is checked or no and update it
                    this.newPrecondition.negate = this.$.button_not_precond.checked;
                    this.$.button_not_precond.checked = false;

                    var check = this.checkPredicate("precondition",this.newPrecondition);
                    if (check.valid) {
                        // We recreate the this.newPrecondition object, else it's passed by reference and it causes problems
                        this.action.preconditions.push({arg1: this.newPrecondition.arg1, name: this.newPrecondition.name, arg2: this.newPrecondition.arg2, negate: this.newPrecondition.negate});
                        this.reevaluateArray('action.preconditions', this.action.preconditions);
                    } else {
                        this.$.msgErrorNewPrecond.innerHTML = check.msg;
                        this.$.errorNewPrecond.open();
                    }
                } else if (condition == "Effect") {
                    // Check if the NOT-button is checked or no and update it
                    this.newEffect.negate = this.$.button_not_effect.checked;
                    this.$.button_not_effect.checked = false;

                    var check = this.checkPredicate("effect", this.newEffect);
                    if (check.valid) {                        
                        this.action.effects.push({arg1: this.newEffect.arg1, name: this.newEffect.name, arg2: this.newEffect.arg2, negate: this.newEffect.negate});                        
                        this.reevaluateArray('action.effects', this.action.effects);
                    } else {
                        this.$.msgErrorNewEffect.innerHTML = check.msg;
                        this.$.errorNewEffect.open();
                    }
                }
            },
            deletePred: function (evt) {
                var item = evt.model.item;
                console.debug('deletePred', item);
                var index = -1;
                index = this.action.preconditions.indexOf(item);
                if (index != -1) {
                    this.splice('action.preconditions', index, 1, );
                    this.reevaluateArray('action.preconditions', this.action.preconditions);
                    console.debug('deletePred from pre');
                } else {
                    index = this.action.effects.indexOf(item);
                    if (index != -1) {
                        this.splice('action.effects', index, 1, );
                        this.reevaluateArray('action.effects', this.action.effects);
                        console.debug('deletePred from eff');
                    }
                }
            },

            reevaluateArray: function (name, property) {
                var conds = property;
                this.set(name, []);
                this.set(name, conds);
            },
            _nameValid: function (name) {
                for (var i = 0; i < this.domain.actions.length; ++i) {
                    if (this.domain.actions[i].name == name) return false;
                }
                return true;
            },
            save: function () {
                if (this.actionName != this.action.name && !this._nameValid(this.actionName)) {
                    alert(this.actionName + ' already exists. Please choose a different name.');
                } else {
                    var msg = {
                        type: 'update pddl action',
                        domain_id: this.domain_id,
                        action_name: this.actionName,
                        pddl_action: this.action
                    };

                    console.debug('Saving ', this.domain, " with name ", this.domain_id);
                    console.debug('Saving ', this.action, " with name ", this.actionName);
                    this.$.eventPub.publish(msg);

                }

            },

            _programUpdated: function (changeRecord) {
                if (changeRecord.base) {
                    if (changeRecord.path !== 'program') {
                        if (changeRecord.path.endsWith('.length')) {
                            return;
                        }
                        var that = this;
                        this.debounce('save', function () {
                            that.save();
                        }, 100);
                    }
                }
            },

            _domainUpdated: function (changedDomain, changedList) {
                if (changedDomain.value) {
                    this.domain = changedDomain.value;
                    //this.getAction(this.actionName);
                }

                if (this.domainList && this.domainList.domains.length == 1) {
                    this.domain_id = this.domainList.domains[0].domain_id;
                }
                /* console.debug('_domainUpdated ', this.pddlDomain);
                console.debug('action is ', this.action); */

            },


            // If a new program is loaded, select step 0.
            _programChanged: function (program, oldProgram) {

                console.log("Program changed:" + program);
                if (!program) {
                    return;
                }
                if (program.steps.length > 0) {
                    this.$.selector.select(program.steps[0]);
                }
            },

            _stepNum: function (index) {
                return parseInt(index) + 1;
            },

            _handleFeedback: function (evt) {
                /* this.currentStepNum = evt.detail.step_number; */
            },

            _handleResult: function (evt) {
                var error = evt.detail.error;
                if (error) {
                    this.error = evt.detail.error;
                    this.$.errorDialog.open();
                } else {

                }
            },

            _handleProgram: function (evt) {
                var program = evt.detail;
                if (!this.program) {
                    this.set('program', program);
                    return;
                }
                if (!_.isEqual(this.program, program)) {
                    this.set('program', program);
                }
            },
            _handleServiceResponse(evt) {
                var id = evt.detail.db_id;
                this.action.program_id = id;
                window.history.pushState({}, null, "#/program/" + id);
                window.dispatchEvent(new CustomEvent("location-changed"));
            },

            _handleServiceError: function (evt) {
                console.error(evt.detail);
            },

            _isRunningChanged: function (isRunning) {
                /* if (isRunning && this.$.rviz != null) {
                    this.$.rviz.set('config.displays.1.isShown', false);
                    this.$.rviz.set('config.displays.2.isShown', false);
                    this.$.rviz.set('config.displays.3.isShown', false);
                    this.$.rviz.set('config.displays.4.isShown', true);
                    this.$.rviz.set('config.displays.5.isShown', true);
                    this.$.rviz.set('config.displays.6.isShown', true);
                } else {
                    this.$.rviz.set('config.displays.1.isShown', true);
                    this.$.rviz.set('config.displays.2.isShown', true);
                    this.$.rviz.set('config.displays.3.isShown', true);
                    this.$.rviz.set('config.displays.4.isShown', false);
                    this.$.rviz.set('config.displays.5.isShown', false);
                    this.$.rviz.set('config.displays.6.isShown', false);
                } */
            },
            _startDemo: function (evt) {
                if (this.action.program_id && this.action.program_id.length > 0) {
                    console.debug('Program already exists ... ', this.action.program_id);
                    window.history.pushState({}, null, "#/program/" + this.action.program_id);
                    window.dispatchEvent(new CustomEvent("location-changed"));
                } else {
                    console.debug('New Program being created ... ');
                    var name = 'Program for: ' + this.actionName;
                    var request = {
                        name: name,
                    };
                    this.$.createSrv.call(request);
                }
                this._finishedDemo = true;
            },

            _detect: function (evt) {
                if (!this.ros) {
                    console.error('Unable to call detection right now.');
                    return;
                }
                var state = evt.target.getAttribute('data-args');
                var msg = {
                    type: 'detect world state',
                    domain_id: this.domain_id,
                    action_name: this.action.name,
                    state_name: state
                };
                this.$.eventPub.publish(msg);
            },
            removeDuplicates: function (a) {
                uniqueArray = a.filter(function (item, pos) {
                    return a.indexOf(item) == pos;
                });
            },
            _getName: function (all_types) {

                var names = ['-'];
                if (all_types) {
                    for (var i = 0; i < all_types.length; ++i) {
                        names.push(all_types[i].name);
                    }
                }
                return this.removeDuplicates(names);
            },

            _getType: function (all_types) {
                var names = ['-'];
                console.debug('_getType: ', all_types);

                if (all_types) {
                    for (var i = 0; i < all_types.length; ++i) {
                        names.push(all_types[i].type.name);
                    }
                }
                return this.removeDuplicates(names);
            },
            _generateConditions: function () {
                // check preconditions and effects are there
                if (this.action.preconditions.length == 0) {
                    console.info('No preconditions');
                }
                if (this.action.effects.length == 0) {
                    console.info('No effects');
                }

                this._getPredicateDiff(this.action.preconditions, this.action.effects);

                this.reevaluateArray('action.preconditions', this.action.preconditions);
                this.reevaluateArray('action.effects', this.action.effects);
                var predList = this.action.preconditions.concat(this.action.effects)
                var parms = this._getParams(predList);
                console.debug(typeof parms, typeof this.action.params);
                console.debug('parms:', parms);
                this.action.params = parms;
                //this.reevaluateArray('action.params', this.action.params);
            },
            _getPredicateDiff: function (list1, list2) {
                // removes predicates which are in both lists

                for (var i = 0; i < list1.length; ++i) {
                    for (var j = 0; j < list2.length; ++j) {
                        if (this._samePredicate(list1[i], list2[j])) {
                            list1.splice(i, 1);
                            list2.splice(j, 1);
                            i--;
                            break;
                        }
                    }
                }
                return [list1, list2];
            },
            _samePredicate: function (pred1, pred2) {
                if (pred1.name != pred2.name) {
                    //console.debug("_samePredicate: name ", pred1, pred2);
                    return false;
                }
                if (pred1.arg1.name != pred2.arg1.name) {
                    //console.debug("_samePredicate: arg1 ", pred1, pred2);
                    return false;
                }
                if (pred1.negate != pred2.negate) {
                    //console.debug("_samePredicate: negate ", pred1, pred2);
                    return false;
                }
                if (pred1.arg2 && pred2.arg2 && pred1.arg2.name != pred2.arg2.name) {
                    //console.debug("_samePredicate: arg2 ", pred1, pred2);
                    return false;
                }
                return true;
            },
            _getParams: function (predList) {
                var params = this.action.params;
                params.length = 0;
                const nameList = new Set([]);
                for (var i = 0; i < predList.length; ++i) {
                    if (predList[i].arg1.name != '' && !nameList.has(predList[i].arg1.name)) {
                        params.push(predList[i].arg1);
                        nameList.add(predList[i].arg1.name);
                    }
                    if (predList[i].arg2 && predList[i].arg2.name != '' && !nameList.has(predList[i].arg2.name)) {
                        params.push(predList[i].arg2);
                        nameList.add(predList[i].arg2.name);
                    }
                }
                return params;
            },
            sortByName: function (arr) {
                arr.sort(function (a, b) {
                    if (a.name < b.name) return -1;
                    if (a.name > b.name) return 1;
                    return 0;
                })
                return arr;
            },
            _goBeforeDemo: function () {
                this._finishedDemo = !this._finishedDemo;
            },
            _negate: function (neg) {
                if (neg) return 'not ';
                else return '';
            }
        });
    </script>
</dom-module>